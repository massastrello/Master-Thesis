\definecolor{brickred}{rgb}{0.8, 0.25, 0.33}
%
\chapter{Multistable Energy Shaping of Linear--Time--Invariant Systems}

\label{chap:multistable}
\minitoc

\thispagestyle{empty}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\lettrine[lines=4]{\color{brickred}E}{xponentially} stable linear--time--invariant (LTI) systems admit a unique equilibrium point, while in many practical situations, they have to operate in a finite number of \textit{working modes} (fixed values of voltages, positions, etc.).
Thus, with standard linear control techniques, a continuous exogenous reference signal must be constantly provided in order to achieve the desired behaviour, e.g. asymptotic stabilisation of a desired set points. The block diagram of classical PID Control scheme is reported in Fig. \ref{fig:PID}.
%
\begin{figure}[!h]
	\centering
	\input{Drawings/error_control_scheme.tex}
	%
	\caption{A block representation of a classic feedback control system.}
	\label{fig:PID}
\end{figure}
%
In order to embed in the controlled system the information on the desired working modes, a nonlinear controller is employed to simultaneously stabilise multiple points, i.e. achieve \textit{multistability} and avoid the need of external reference signals.
The introduction of the nonlinear terms gives rise to interesting properties of the controlled system, e.g. the possibility of shaping the basins of attraction of the different fixed points.
Appealing studies on the inverse problem, i.e., turning \textit{monostable} a {multistable} nonlinear system, have already been presented by \cite{PISARCHIK2014167}.
\newline

%
In this chapter, considering that stable LTI system can be made passive through an opportune choice of input and output (\cite{byrnes91}), a nonlinear controller able to stabilize multiple points is designed following a port-Hamiltonian paradigm, (\cite{876703,secchi2007control,ortega2008control,van2014port}). Then, in order to switch among the working modes, a \textit{mode selector} is developed exploiting the theory of hybrid dynamical systems (\cite{van2000introduction,goebel2008}). A graphical representation of a state--space trajectory for the proposed controlled system is shown in Fig. \ref{fig:mesh_graph}.
%
\begin{figure}[!ht]
    \centering
    \includegraphics{Drawings/draw.pdf}
    \caption{Graphical representation of a state-space trajectory of the controlled system.}
    \label{fig:mesh_graph}
\end{figure}
%
\newline

%
Moreover, it is shown that the controlled system falls in the framework of hybrid port--Hamiltonian systems, proving the generality and applicability of the newly developed theory.
%

\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Multistable Energy Shaping of LTI Systems}\label{sec:multistable}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In this section a nonlinear feedback law for a LTI system is designed to stabilise multiple fixed points. Passivity and the properties of passive LTI systems are briefly discussed.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Passivity of LTI Systems}
%
Let us consider the stable LTI specialization of (\ref{eq:nlaffine}), i.e. the standard system with state space realization
%
\begin{equation}\label{eq:lsys}
\left\{
\begin{matrix*}[l]
\dot{\xb}(t) = \Ab\xb(t) + \Bb\ub(t)\\
\yb(t) = \Cb\xb(t)
\end{matrix*}
\right.
\end{equation}
with system matrices $(\Ab,\Bb,\Cb)$ of appropriate dimensions and let $\Ab$ be Hurwitz.
%
{
It is easy to verify that, once system (\ref{eq:lsys}) is equipped with a quadratic storage function 
\begin{equation}
    \Ha(\xb) = \frac{1}{2}\xb^\top \Pb\xb,~\Pb = \Pb^\top \succ 0,
\end{equation}
it enjoys the KPY property, i.e. it is passive, if and only if
%
\begin{equation}\label{eq:KYPLTI}
        \Ab^\top \Pb + \Pb\Ab \leq 0\quad
        \Bb^\top \Pb = \Cb.
    %\end{matrix*}
    %\right.
\end{equation}
%
\begin{rem}
    It is worth to be noticed that passivity could just be tested by the definition:
    $(\Ab,\Bb,\Cb)$ is passive if and only if it is dissipative with respect to the supply rate $\langle \yb,\ub \rangle\triangleq \yb^\top \ub$, i.e.,  if and only if there exists $\Ha\in\C^1$,
    %
    \begin{equation}
        \dot{\Ha}\leq \yb^\top \ub
    \end{equation}
    %
    Thus, it yields,
    %
    \begin{align}
        \dot{\Ha} =  \frac{1}{2}\xb^\top \left(\Ab^\top \Pb + \Pb\Ab\right)\xb + \xb^\top \Pb\Bb\ub \leq \xb^\top \Cb^\top \ub
    \end{align}
    %
    which is true if and only if (\ref{eq:KYPLTI}) hold.
\end{rem}
%
Furthermore, for system (\ref{eq:lsys}) with $\Ab$ stable and $\ub=\mymathbb{0}_m$, the storage function is non increasing along trajectories, i.e.
%
\begin{equation}
    \dot{\Ha}(\xb) =  \frac{1}{2}\xb^\top \left(\Ab^\top \Pb + \Pb\Ab\right)\xb\leq 0\quad\forall \xb\in\X.
\end{equation}
%
This means that the \textit{natural} dissipation inferred by the choice of $\Pb$ of the autonomous system corresponds to $\frac{1}{2}\xb^\top \left(\Ab^\top \Pb + \Pb\Ab\right)\xb$ where $\Ab^\top\Pb+\Pb\Ab\preceq 0$. 
}
%
In order to present clearly the upcoming concepts, the following prototype linear system has been chosen as example to be invoked throughout the chapter.
%
\begin{exmp}\label{ex:msd_MES}
    Consider a forced mass--spring--damper system of example \ref{ex:msd} with unitary mass, i.e. $k>0$, $m = 1$, $p = \dot{q}$ and $\xb\triangleq (q,p)$.
    The LTI state--space (\ref{eq:lsys}) representation is
    %
    \begin{equation}
        \dot{\xb} = \underbrace{\begin{bmatrix}0&1\\-k&-b\end{bmatrix}}_{\Ab}\xb+ \underbrace{\begin{bmatrix}0\\1\end{bmatrix}}_{\Bb}u.
    \end{equation}
    %
    The autonomous system is exponentially stable if $b>0$. Let $\Pb=\diag({k,1})$. Indeed $\Pb=\Pb^\top\succ0$ and $\Ab^\top\Pb+\Pb\Ab\prec0$. Thus, the system is passified (with storage function $\Ha = \frac{1}{2}\xb^\top \Pb\xb$) choosing the linear output as $\yb \triangleq \Bb^\top \Pb\xb = \dot{q}$, as also derived by first principles in Chapter \ref{chap:preliminaries}. Note that $\Ha$ is the total energy of the system. In general, any mechanical systems is passive with its total energy as storage function by choosing as input(s) the (generalised) forces and as output(s) the (generalised) momenta.
\end{exmp}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Multistable Passivity--Based Control of LTI Systems}
%
Any passive LTI system (\ref{eq:lsys}) with storage function $\Ha(\xb) = \frac{1}{2}\xb^\top \Pb\xb$ such that $\Null(\Pb)$ $\subseteq$ $\Null(\Ab)$ admits a port-Hamiltonian representation\footnote{Since we choose $\Pb>0$, this condition does not represent a loss of generality, i.e. any system (\ref{eq:lsys}) can be written in PH form.}:
%
\begin{equation}
    \left\{
    \begin{matrix*}[l]
    \dot{\xb} = \left[\Jb-\Rb\right]\Pb\xb + \Bb\ub\\
    \yb = \Bb^\top \Pb\xb
    \end{matrix*}
    \right.
\end{equation}
%
where 
%
\begin{equation}
    \Jb \triangleq \frac{1}{2}(\Ab\Pb^{-1}-\Pb^{-1}\Ab^\top),\quad\Rb \triangleq- \frac{1}{2}(\Ab\Pb^{-1}+\Pb^{-1}\Ab^\top).
\end{equation}
% 
are derived by the following relations:
%
\begin{align}
    & \Ab = \left[\Jb-\Rb\right]\Pb\\
    & \left(\Jb-\Rb\right)^\top + \left(\Jb-\Rb\right) = -2\Rb.
\end{align}
%
Thus, for a LTI system, the energy balancing control law (\ref{eq:ebpbc}) becomes 
%
\begin{align}\label{eq:multiebpbc_lin}
    \bm\beta(\xb) &= -\left(\Bb^\top\Bb\right)^{-1}\Bb^\top\Pb^{-1}\Ab^\top\bm\nabla\Ha_a
\end{align}
%
with
%
\begin{equation}
    \Ha_a\triangleq\Ha^*-\frac{1}{2}\xb^\top \Pb\xb
\end{equation}
%
and the matching conditions:
%
\begin{equation}\label{eq:match_lin}
    \begin{bmatrix}
        {\Bb}^{\perp}\left[\Jb-\Rb\right]^\top\\
        {\Bb}^\top
    \end{bmatrix}
    %
    \bm\nabla\Ha_a =\mymathbb{0}_{n+m}.
\end{equation}
%
\begin{prop}[Multistable EB--PBC of LTI System]
	Consider a passive LTI system (\ref{eq:lsys}) equipped with a quadratic storage function $\Ha(\xb) = \frac{1}{2}\xb^\top \Pb\xb$. Let $\Ha^*\in\C^2$ be a desired storage (energy) function with $p$ minima corresponding to $p$ desired equilibrium points $\xb^*_i$, i.e.
	%
	\begin{equation}
	\bm\nabla\Ha^*\big|_{\xb = \xb^*_i} = \mymathbb{0}_n,~~~ \bm\nabla^2 \Ha^*\big|_{\xb = \xb^*_i}>0\quad\forall i = 1,\dots,p.
	\end{equation}
	%
	The EB--PBC control action (\ref{eq:multiebpbc_lin})
	%
	stabilises the desired equilibrium points $\xb^*_i$ if (\ref{eq:match_lin}) holds true for the chosen $\Ha^*$.
    %
\end{prop}
%
\proof
The proof follows similarly to \citep{ortega2008control}. Indeed, the minimum points of $\Ha^*$ will result to be Lyapunov stable equilibria in the same way in which EB--PBC acts on a single fixed point. It follows that if $\Ab$ is Hurwitz, the new ``shaped'' energy $\Ha^*$ will be monotonically decreasing along any trajectory since $\Ab^\top \Pb + \Pb\Ab\prec 0$ and, thus, if it is bounded from below the system will reach asymptotically one of the minima of $\Ha^*$. However, if the linear system is only stable, i.e. $\Ab^\top \Pb + \Pb\Ab\preceq 0$, then locally invariant sets have to be examined by means of La Salleâ€™s invariance theorem to check asymptotic stability \citep{khalil2002nonlinear}.
\endproof
%
\begin{rem}
	Deeper evaluations and considerations on Lyapunov functions for multistable nonlinear systems are reported in \cite{efimov2012global}. It has to be underlined that, in order to have an energy function with multiple minima, it is necessary to have the presence of local maxima, which however do not affect global behaviour of the system, since those are just unstable fixed points of the closed loop system.
	
\end{rem}
%
Furthermore, in the case of LTI systems, the damping injection takes the form
\begin{equation}
    \vb = \mathbf{K}_d\Bb^\top\Pb\xb
\end{equation}
A block diagram  picturing the overall control scheme is represented in Fig. \ref{fig:block}.
%
\begin{figure}[!h]
	\centering
	\input{Drawings/scheme.tex}
	%
	\caption{A block representation of the controlled system.}
	\label{fig:block}
\end{figure}
%
\subsection{Application Example \ref{ex:msd_MES}}
%
Consider the system in Example \ref{ex:msd_MES} and let the desired energy function have two symmetrically distributed minima on the displacement axes, e.g.,
%
\begin{equation}
    \Ha^*(q,p) = \lambda q^4-\mu q^2 + \frac{1}{2}p^2 + \frac{\mu^2}{4\lambda}\qquad\lambda,\mu>0
\end{equation}
%
which has two minima in $[\pm\sqrt{\mu/2\lambda},0]^\top$ and a local maximum in $[0,0]^\top$. The desired energy function is plotted in Figure \ref{fig:shaped_en}
%
\begin{figure}
    \centering
    \input{Drawings/ShapedEnergy.tex}
    \caption[Desired shaped energy function]{Desired shaped energy function $\Ha^*(q,p) = \lambda q^4-\mu q^2 + \frac{1}{2}p^2 + \frac{\mu^2}{4\lambda}$}
    \label{fig:shaped_en}
\end{figure}
%
Thus, 
%
\begin{align}
    \Ha_a & = \Ha^* - \Ha \\
          & = \lambda q^4-(\mu+\frac{1}{2}\kappa)q^2 + \frac{1}{2}p^2 + \frac{\mu^2}{4\lambda}
\end{align}
%
and, therefore
%
\begin{equation}
    \bm\nabla\Ha_a = (4\lambda q^3-(2\mu + k)q,p).
\end{equation}
%
It is easy to proof that the matching conditions (\ref{eq:match_lin}) of the EB--PBC are satisfied for $\Ha_a$. The energy shaping control law becomes
%
\begin{align}\label{eq:ex_ctrl}
    \beta(q) &= -\begin{bmatrix}0&1\end{bmatrix}\begin{bmatrix}0&-1\\1&-b\end{bmatrix}\begin{bmatrix}4\lambda q^3-(2\mu + k)q\\p\end{bmatrix}\\
             &= -4\lambda q^3+(2\mu + k)q.
\end{align}
%
A numerical simulation of the proposed control scheme has been performed with $k = 1$, $b = 0.5$. The parameters $\lambda$ and $\mu$ have been set to $2$ and $1$ respectively, placing the minima of $\Ha^*$ in $[\pm0.5,0]^\top$. No damping injection actions has been added as the asymptotic stability is already guaranteed by the natural dissipation of the autonomous linear system. Starting in the initial position $\xb_0 \triangleq (-0.9,0)$ the system has been simulated for both the  autonomous and the multistable EB--PBC controlled system for $40s$. The resulting phase--space portraits are reported in Fig. \ref{fig:ctrl_ps}.
%
\begin{figure}[!ht]
    \centering
    \input{Drawings/ctrl_ps.tex}
    %
    \caption[Phase--space portraits of the autonomous and the multistable EB--PBC controlled system]{Comparison of the phase--space portraits of the autonomous and the multistable EB--PBC controlled system with $k = 1$, $b = 0.5$, $\lambda = 2$, $\mu = 1$. The phase--space portraits are represents over contour plots of the corresponding energy functions, i.e., $\Ha = \frac{1}{2}(kq + p)$ and  $\Ha^* =  2q^4 - q^2 + \frac{1}{2}p + \frac{1}{8}$. The red dots indicates the critical points of $\Ha$ and $\Ha^*$.}
    \label{fig:ctrl_ps}
\end{figure}
%
\iffalse
Note that the damping injection control action $v = -ky$ does not change the location of the fixed points of the system. 
%{\color{red}
\begin{prop}\label{prop:db_lin}
Let $u = v$ ($\beta(x) = \mathbb{0}_m$), it holds:
%
\[\mymathbb{0}_n = Ax - k BB^\top Px = \left(A-kBB^\top P\right)x\]
if and only if $x = \mymathbb{0}_n$.
%
\end{prop}
%
%
\begin{proof}
Necessary and sufficient condition to have 
\[\mymathbb{0}_n = \left(A-kBB^\top P\right)x~\Leftrightarrow~x = \mathbb{0}_n\]
is the matrix $A-kBB^\top P$ to be full--rank. 
Let $S = kBB^\top P$ which is positive semi--definite for $k>0$ since $P>0$. In particular, $\rank(S) = m$ because $P$ is full--rank and $\rank(B) = m$. Since $A$ is full--rank, it holds:
\[\rank(A-S) + \dim[\Null(A-S)] = \rank(A)\]
Furthermore, 
\[\Null(A-S) = \Null(I_n - A^{-1}S)\]
Thus, $A-S$ is full--rank if and only if 
\[\det(I_n - A^{-1}S)\neq 0\]
Indeed, $A^{-1}S$ is negative semi--definite since $A<0$ and $S\geq 0$. Let $p(s)$ be characteristic polynomial of $A^{-1}S$, i,e,
\[p(s) = \det(A^{-1}S - sI_n) = \prod_{i = 1}^n(\alpha_i-s) = (-1)^n\prod_{i = 1}^n(s-\alpha_i)\]
where $\alpha_i$ ($i = 1,\dots,n$) are the eigenvalues of $A^{-1}S$.
Hence, by setting $s = 1$, yields
\[\det(I-A^{-1}S) = (-1)^n(-1)^n\prod_{i = 1}^n(1-\alpha_i) = \prod_{i = 1}^n(1-\alpha_i)\]
Since $\alpha_i\leq 0~\forall i = 1,\dots,n$, the product is strictly positive and this proves $\det(I_n - A^{-1}S)\neq 0$. Therefore, $\dim[\Null(A-S)] = 0$ and, eventually,
\[\rank(A-kBB^\top P) = \rank(A) = n\]
which proves the proposition.\\
$\blacksquare$
\end{proof}
%
A similar proposition can be proved in the case of the energy--shaping controlled linear system, i.e. $\beta(x) = B^+(J-R)\partial\Ha_a$, using the port--Hamiltonian form of the model.
\begin{prop}
Let the energy--shaping controlled system be:
\begin{align*}
    &\dot{x}=(J-R)\partial\Ha^* + Bv\\
    &y = B^\top\partial\Ha^* 
\end{align*}
The control law $v = -ky$ does not modify the fixed points of the system i.e.
\[\mathbb{0}_n=(J-R)\partial\Ha^*-kBB^\top\partial\Ha^*=\left[(J-R)-kBB^\top\right]\partial\Ha^*\]
if and only if $\partial\Ha^*=0$.
\end{prop}
\begin{proof}
As in Proposition \ref{prop:db_lin}, the necessary and sufficient condition so that the previous statement holds is equivalent to asking if the matrix $(J-R)-kBB^\top$ is full--rank.
Recalling that $J-R=AP^{-1}$, it holds:
\begin{align*}
    \rank(J-R-kBB^\top) &= \rank[(J-R-kBB^\top)P]\\
    &=\rank(A-kBB^\top P)\\
    &=\rank(A)=n
\end{align*}
thanks to Proposition \ref{prop:db_lin}.\\
$\blacksquare$
\end{proof}
\fi
%
\subsection{Choice of the Dissipation Rate: Shaping the basins of attraction}
%
In this section it is shown how, by tuning the dissipation rate $\mathbf{K_d}$, it is possible to shape the basins of attraction of the designed stable fixed points of the closed--loop system.
%
\begin{defn}
The \textit{basin of attraction} $\B$ of a fixed point $\xb^*$ of a system (\ref{eq:nlaffine}) is the set of all initial conditions $\xb_0$ leading to long--time behavior that approaches that fixed point, i.e.
%
\begin{equation*}
    \B \triangleq \left\{\xb_0\in\X|\lim \limits_{t\rightarrow\infty}\Phi(t,\xb_0,\ub)=\xb^*\right\}.
\end{equation*}
%
\end{defn}
%
The designed feedback control law (\ref{eq:ex_ctrl}) allows to fix multiple stable points for the closed--loop system. The damping injection component of the overall control action can be used to ``shape'' their basins of attraction. This property allows to have interesting control actions which will be qualitatively shown.
%
Consider the system of Example \ref{ex:msd_MES} controlled by the energy shaping control law (\ref{eq:ex_ctrl}). The closed--loop system in the form (\ref{eq:nlaffine}) can be expressed as
%
\begin{equation*}
	\left\{
    \begin{matrix*}[l]
    \dot{\xb} = \begin{bmatrix}p\\-4\lambda q^3+2\mu q-bp\end{bmatrix} + \Bb v\\
    y = \Bb^\top \Pb\xb
    \end{matrix*}
    \right. .
\end{equation*}
%
If $v= 0$ the system has two asymptotically stable fixed points in $[\pm\sqrt{\mu/2\lambda},0]^\top$.Let $\mathbf{K}_d \triangleq k_d$. The output feedback controller $v = -k_d y = -k_dp$ does not change the location of the fixed points. In facts, it only changes the overall friction of the system from $b$ to $b+k_d$, i.e. the natural dissipation of the closed--loop system from $bp^2$ to $(b+k_d)p^2$.
%
Besides, the respective basins of attraction strongly depend on the choice of the controller, i.e., on the value of $k_d$. In Fig. \ref{fig:basin} the basins of attraction of the two fixed points are shown for different values of $k_d$ in the region $[-1,1]\times [-1,1]$ of the state space with $b = 0$, $\lambda = 2$, $\mu = 1$. It is evident that the higher the dissipation rate is, the lower is the number of transitions between basins of attraction.
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\textwidth]{Figures/basin6.eps}
	\caption[Basins of attraction of the fixed points of the system for different values of $k_d$]{Basins of attraction of the fixed points of the system for different values of $k_d$ in the region $[-1,1]\times [-1,1]$. The basin of attraction of the minima [blue points] are represented in dark gray (for $(-0.5,0)$ and light hatched gray (for $(0.5,0)$). The blue point in $(0,0)$ is the local maximum of $\Ha^*$.}
	\label{fig:basin}
\end{figure}
%
%\iffalse
\newline

%
Therefore, given an initial condition $\xb_0$, and a desired set point $\xb_i^*$, corresponding to one of the minima of $\Ha^*$, we would be interested in choosing a dissipation rate $\mathbf{K}_d=\mathbf{K}_d^\top\succeq 0$ such that $\xb_0$ belongs to the basin of attraction $\B_i$ of $\xb_i^*$. 

From now on, we will consider the topology on $\R^n$ to be the \textit{standard} one, i.e. the one induced by the euclidian metric. Furthermore, given an open set $\Sa\subset\R^n$, let us denote its closure with $\bar{\Sa}$.
%
\begin{thm}(Necessity)\label{thm:necessity}
Let $c$ be the initial energy, $c = \Ha^*(\xb_0)$. Let $\Lambda_c$ be the $c$--level set of $\Ha^*$, $L_c\Ha^* = \{\xb~:~\Ha^*(\xb)=c\}\subset\R^n$. If there exists a $\mathbf{K}_d = \mathbf{K}_d^\top\succeq 0$ such that $\xb_0\in\B_i$, then one of the following is necessarily satisfied:
\begin{itemize}
    \item[$1.$] ${L}_c\Ha^*$ is connected and 
    \[\exists \Gamma:\partial \Gamma = L_c\Ha^* ~\land~ \xb_i^*\in \bar{\Gamma}\]
    \item[$2.$] $L_c\Ha^*$ is not connected but it is the union of $r$ connected sets $L_c^1\Ha^*_c,\dots,L_c^r\Ha^*$ and
    \[\exists {\Gamma}_j:\partial \Gamma_j = L_c^j\Ha^* ~\land~ \xb_0,\xb_i^*\in \Bar{\Gamma}_j\]
\end{itemize}
\end{thm}
%
\begin{proof}
Due to dissipativity of the controlled system, i.e.
%
\begin{equation}
    \dot{\Ha}^*\leq \yb^\top\vb =-\xb\Pb\Bb\mathbf{K}_d\Bb^\top\Pb\xb\leq 0 \quad\forall \mathbf{K}_d=\mathbf{K}_d^\top\succeq 0
\end{equation}
%
the any trajectory with initial condition will lie inside the closure of the set $\Gamma$ defined as 
%
\begin{equation}
    \partial \Gamma \triangleq {L}_c\Ha^*
\end{equation}
%
regardless on the choice of $\mathbf{K}_d$, i.e.,
%
\begin{equation}
    \forall t,~\forall \mathbf{K}_d=\mathbf{K}_d^\top\succeq 0\quad\bm\phi(t,\xb_0,\ub)\in \bar{\Gamma}
\end{equation}
%
Therefore, if $\xb_i^*\not\in\bar{\Gamma}$, it is impossible to reach it, i.e.,
%
\begin{equation}
    \xb_i^*\not\in\bar{\Gamma} \Rightarrow \nexists \mathbf{K}_d=\mathbf{K}_d^\top\succeq 0~:~\xb_0\in\B_i 
\end{equation}
%
If ${L}_c\Ha^*$ is connected also $\bar{\Gamma}$ is connected and $\xb_0\in\partial \Gamma\subset \bar{\Gamma}$, then the necessary condition for the existence of a $\mathbf{K}_d=\mathbf{K}_d^\top\succeq 0$ such that $\xb_0\in\B_i$ is simply: $\x_i^*\in\bar{\Gamma}$. On the other hand if ${L}_c\Ha^*$ is not connected but it is the union of connected sets, the trajectory will never leave the set $\bar{\Gamma}_j$ defined by 
%
\begin{equation}
    \partial \Gamma_j \triangleq {L}_c^j\Ha^*
\end{equation}
%
where
\[{L}_c\Ha^* = \bigcup_{k = 1}^m{L}_c^k\Ha^*~~\text{and}~~\xb_0\in{L}_c^j\Ha^* \] 
Thus, the necessary condition is that also $\xb_i^*$ belongs to $\bar{\Gamma}_j$.
\end{proof}
%
A graphical representation of this necessary condition is given in Fig. \ref{fig:nec}.
%
\begin{figure}
    \centering
    \includegraphics[scale = 0.5]{Drawings/draw3.pdf}
    \caption{Graphical representation of the necessary condition given by \ref{thm:necessity}. Case (A): the condition is satisfied for all the stable fixed points $x_i^*,~x_j^*$ and $x_k^*$. Case (B): the condition is satisfied for $x_i^*,~x_j^*$ but not for $x_k^*$. Case (C): the condition is satisfied only for $x_i^*$.}
    \label{fig:nec}
\end{figure}
%

In order to choose among the possibly infinite values of $\mathbf{K}_d$ such that  $\xb_0\in\B_i$, one could minimise both the approaching time and the damping injection control effort needed to bring $\xb(t)$ from $\xb_0$ to $\xb_i^*$, i.e.,
%
\begin{equation}
    \begin{aligned}
        & \underset{\mathbf{K}_d}{\text{minimize}}
        & & \int_0^\infty\left( (\xb(s)-\xb_i^*)^\top\mathbf{Q}(\xb(s)-\xb_i^*) + \xb(s)\Pb\Bb\mathbf{K}_d\mathbf{S}\mathbf{K}_d\Bb^\top \Pb\xb(s)\right)ds \\
        & \text{subject to}
        & &\lim\limits_{t\rightarrow\infty}\bm\phi(t,\xb_0,\bm\beta(\xb)-\mathbf{K}_d\Bb^\top \Pb\xb)=\xb^*_i
    \end{aligned}
\end{equation}
%
with $\mathbf{Q}=\mathbf{Q}^\top\succeq 0$, $\mathbf{S}=\mathbf{S}^\top\succeq 0$.
%
\clearpage
%
\section{Hybrid Mode Selector}
%
Once the feedback law and the damping injection are designed to produce the desired working modes and to shape their basins of attraction, the proposed strategy aims to switch from a working mode to another.
In particular, considering the system to be in one of the working modes $\xb_i^*$, a control action which moves the system to another desired mode, $\xb_j^*$, is designed.
The strategy reckons on the following actions:
\begin{itemize}
    \item [1.] Switch-off the energy shaping controller (the system turns back linear);
    \item [2.] Give an impulse to the system to bring the state inside the basin of attraction of $\xb_j^*$;
    \item [3.] Switch on again the energy shaping controller.
\end{itemize}
%
\subsection{Impulse generation}
When the nonlinear controller $\ub=\bm\beta(\xb)+\vb$ is switched off, i.e. $\ub=\mymathbb{0}_m$, the system turns back in the LTI form (\ref{eq:lsys}).
Without loss of generality, let $t = 0$ and let the LTI system be controllable. The response of the system to a weighted impulse input 
%
\begin{equation}
\ub(t) = \bm\nu\delta(t)
\end{equation}
%
where $\bm\nu\in\R^m$ distributes the Dirac delta function $\delta(t)$ among the $m$ inputs,
is
%
\begin{align}\label{eq:impresp}
    \xb(t) &= e^{t\Ab}\xb_0 + \int_0^te^{(t-s)\Ab}\Bb \ub(s)ds =\nonumber\\
    &= e^{t\Ab}\xb_0 + \int_0^te^{(t-s)\Ab}\Bb\bm\nu\delta(s)ds \nonumber\\
    &= e^{t\Ab}\xb_0 + e^{t\Ab}\Bb\bm\nu\\
    &= e^{t\Ab}\left(\xb_0 + \Bb\bm\nu\right) .
\end{align}
%
Since the control objective is to move the system from $\xb_i^*$ to $\xb_j^*$ in a time $t^*$, it is tempting to impose the desired behaviour in (\ref{eq:impresp}) by requiring:
%
\begin{equation}\label{eq:cond}
    \xb_j^* \triangleq \xb(t^*) = e^{t^*\Ab}\left(\xb_i^* + \Bb\bm\nu\right).
\end{equation}
%
Therefore, $\bm\nu$ might be obtained as
\begin{align}
    \bm\nu = \left(\Bb^\top\Bb\right)^{-1}\Bb^\top(e^{-t^*\Ab}\xb_j^*-\xb_i^*).
\end{align}
%
However, unless $m = n$, (\ref{eq:cond}) is overdetermined, i.e. $n$ (scalar) equations with only $m$ unknowns (the components of $\bm\nu$). 
To overcome this issue, the design of the impulse controller is achieved by solving the following optimisation problem: 
find $t^*$, $\bm\nu$ such that 
%
\begin{equation}\label{eq:opti}
\begin{aligned}
& [t^*,\bm\nu] = \argmin\limits_{t^*,\bm\nu}\gamma\left\|\bm\nu \right\|^2_2+\rho\left\|\xb_j^* - e^{t^*\Ab}\left(\xb_i^*+\Bb\bm\nu\right)\right\|^2_2\\
& \text{subject to} ~~\bm\varphi\left(t^*,\xb_i^*,\bm\nu\delta(t)\right)\in\B_j
\end{aligned}
\end{equation}
where $\gamma,~\rho\in \R^+$ are two arbitrary weights and  $\B_j$ is the basin of attraction of $\xb_j^*$. 
The term $\gamma\|\bm\nu\|_2^2$ has been introduce for regularization since, in some cases, it might be convenient to simultaneously minimise also the squared norm of the impulse weights.
%

The solution of (\ref{eq:opti}), provides an impulsive input  $\ub = \bm\nu\delta$ which guarantee that the system will arrive in $\B_j$ in a time $t^*$.  
For the sake of a latter numerical implementation, the constraint was defined as
\begin{align}
    \left\|\hat{\bm\varphi}\left(t_{\infty},e^{t^*\Ab}\left(\xb_i^*+\Bb\bm\nu\right),\bm\beta(\xb)-\mathbf{K}_d\Bb^\top \Pb\xb\right)-\xb^*_j\right\|_2\leq\varepsilon
\end{align}
%
where $\hat{\bm\varphi}$ is the numerically integrated trajectory of the system, $t_\infty\gg 1$ is the integration time and $0\leq\varepsilon \ll 1$ is a chosen threshold.
%
\begin{rem}
	Assuming that the switch is performed only at steady--state, the optimisation of $\bm\nu$ and $t^*$ for each pair of fixed points $\xb_i$, $\xb_j$ can be performed off--line.
\end{rem}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Overall Hybrid System}
%
If an impulse is applied to the system at time $t$  in order to reach the desired destination $\xb_j^*$, in the instant of time in which the impulse is applied, the state undergoes to a discontinuous jump
%
\begin{equation}\label{eq:jump}
    \xb^+ = \xb(t) + \Bb\bm\nu.
\end{equation}
%
Therefore, the controlled system can be described as an \textit{hybrid automata}, with two logic states $\Sa_1$ and $\Sa_2$. In $\Sa_1$ the system is controlled with the multistable EB--PBC and in $\Sa_2$ the system is completely uncontrolled. Thus, by introducing a timer $\tau$ and an external asynchronous signal $r$ (initialised to $0$), the transition from $\Sa_1$ to $\Sa_2$ will happen when $r$ changes from $0$ to the index of the desired fixed point, i.e., $r\in\{0,1,\dots,p\}$, with a state jump described by (\ref{eq:jump}) and resetting the timer $\tau$ to $0$. Then the system will remain uncontrolled (and thus linear) for a time $t^*$, i.e. $\tau = t^*$ after which the logic state will switch back from $\Sa_2$ to $\Sa_1$  and the timer and the external signal $r$ will be reset. A graphical representation of the designed hybrid automata is given in Fig. \ref{fig:automata}. 
%
\begin{figure}[!ht]
	\centering
	\input{Drawings/Automata.tex}
	\caption{Hybrid automata representing the overall controlled system with the hybrid mode selector.}
	\label{fig:automata}
\end{figure}
%
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Hybrid Port--Hamiltonian Model and Stability}
%
% From the hybrid automata representation of Fig. \ref{fig:automata} the extended hybrid port--Hamiltonian model can be obtained. First, the system has two PH flows: one when the system is controlled via multistable EB-PBC
% %
% \begin{equation}
%     \dot{\xb} = \Ab\Pb^{-1}\bm\nabla\Ha_1(\xb) + \Bb\vb
% \end{equation}
% %
% and one when the controller is switched-off
% %
% \begin{equation}
%     \dot{\xb} = \Ab\Pb^{-1}\bm\nabla\Ha_2(\xb)
% \end{equation}
% %
% By introducing a dummy variable $s$, representing the logic state of the system, i.e. $s = i$ in $\Sa_i$, and performing a state extension:
% %
% \begin{equation}
%     \zb \triangleq \left(\xb, \tau,r,s\right)
% \end{equation}
% %
% the flow set can be defined as the union of two subsets $\C_1$ and $\C_2$ corresponding to the logic states of the system, i.e.
% %
% \begin{equation}
%     \C \triangleq \C_1\cup\C_2
% \end{equation}
% %
% where
% %
% \begin{equation}
%     \C_i\triangleq \{\zb: s = i\}.
% \end{equation}
% %
% The port--Hamiltonian set--valued mapping $\F_{\tt PH}$ can be then defined as
% %
% \begin{equation}
% 48
% \end{equation}
% %
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Numerical Simulation}
%
A numerical simulation of the overall controlled system has been performed to validate the proposed control scheme. The whole procedure has been implemented in the \textsc{Matlab}\textsuperscript{\textregistered}%\footnote{The source code is available at \url{https://github.com/massastrello/MultistableControl}.} 
environment. The system introduced in Example \ref{ex:msd_MES} has been controlled with the multistable energy shaping (\ref{eq:ex_ctrl}) and the damping injection $v = -\kappa\dot{\xi}$. The system parameters has been chosen as $k = 5$, $b = 0.5$ and, as in the example in Section \ref{sec:multistable}, the minima of $\Ha^*$ have been positioned in $[\pm 0.5,0]^\top$ by setting $\lambda = 2$ and $\mu = 1$.
{%\color{red}
To implement the asynchronous external control signal $r$, the two fixed points have been denoted with $\xb_1^* = [-0.5,0]^\top$ and $\xb_2^* = [0.5,0]^\top$.}
The dissipation rate $k_d$ has been set to $4.5$. 
The \textit{fmincon} solver of the \textit{global optimization toolbox} of \textsc{Matlab}\textsuperscript{\textregistered} has been employed to solve the optimisation problem (\ref{eq:opti}). The optimisation parameters have been chosen as $t_\infty=10^3$, $\varepsilon=10^{-5}$, considering an absolute tolerance of $10^{-6}$ for the numerical integration (ODE45).
Starting from the initial state $\xb_0 \triangleq [-0.8,0]^\top$, the system, controlled with the nonlinear state feedback and the damping injection, has been integrated until secured convergence to $\xb_1^*$ ($5s$). Then, $r$ has been set to 2 in order to trigger the change of working mode, i.e. to bring the state to $\xb_2^*$. After the jump, the system has been let flowing uncontrolled for a time $t^*$ and then the nonlinear controller has been turned on again. After other $5s$ the procedure has been repeated, by setting $r$ to 1 and bring the state back in $\xb_1^*$.
This simulation has been performed twice, with different values of $\gamma$ for the impulse design process (performed off--line); $\rho$ has been set to 1 in both cases. 

First, $\gamma$ has been set to $10^{-3}$ to emphasise the minimisation of the norm of the error 
%
\begin{equation}
    \|\mathbf{e}\|_2^2=\left\|\xb_j^* - e^{t^*\Ab}\left(\xb_i^*+\Bb\bm\nu\right)\right\|^2_2.
\end{equation}
%
Then, $\gamma$ has been set to 2, accentuating the minimisation of the squared norm $\|\bm\nu\|_2^2$ of the impulse weights vector (in this case $\nu\in\R$). The numerical results of the optimisation are reported in Table \ref{tab:opti} while the system trajectories are shown in Figs. \ref{fig:exp1} and \ref{fig:exp2}. 
%
\begin{table}[!ht]
    \caption{Hybrid controller optimisation results.}
	\centering
	\subtable[$1^{\text{st}}$ impulse ($x_1^*\rightarrow \B_2$)]{
		\begin{tabular}{|c|c|c|c|}\hline
			\rowcolor{gray!50} $\gamma$ & $\|e\|_2^2$ &$\nu$  & $t^*$  \\\hline
            $10^{-3}$  & 0.00 & 1.05 & 1.04 \\\hline
			$2$      & 0.15 & 0.00      & 1.41 \\\hline
		\end{tabular}
	}
	\subtable[$2^{\text{nd}}$ impulse ($x_2^*\rightarrow \B_1$)]{
		%\centering
		\begin{tabular}{|c|c|c|c|}\hline
			\rowcolor{gray!50} $\gamma$ & $\|e\|_2^2$ & $\nu$  & $t^*$   \\\hline
            $10^{-3}$ & 0.00 & 1.05 & -1.05 \\\hline
			$2$      & 0.15 & 0.00      & 1.42  \\\hline
		\end{tabular}
	} 
	\label{tab:opti}
\end{table}	
%
\begin{figure}[!ht]
    \centering
    \subfigure[Time evolution of the states $q$ $p$.]{\input{Drawings/timev1.tex}}
    \subfigure[Phase--space portrait.]{\input{Drawings/ps1.tex}}
    %
    \caption[Simulation experiment of the overall hybrid system with $\gamma = 10^{-3}$.]{Simulation experiment of the overall hybrid system carried out by settling $\gamma = 10^{-3}$. The system parameters where $k = 5$, $b = 0.5$, $\lambda = 2$, $\mu = 1$, $k_d = 4.5$ and $\x_0 = (-0.8,0)$. 
    Two switching signals have been given to the system in order to trigger the change of fixed point at $t = 5s$ and $t = 11.03s$. Black solid lines are parts of the system's trajectory with the nonlinear controller, red dashed lines indicates state discontinuities and the blue solid lines denote that the system was flowing uncontrolled. The dashed green lines are the the fixed points.
    }
    \label{fig:exp1}
\end{figure}
% %%
\begin{figure}[!ht]
	\centering
	\subfigure[Time evolution of the states $q$ $p$.]{\input{Drawings/timev2.tex}}
	%
	\subfigure[Phase--space portrait.]{\input{Drawings/ps2.tex}}
	%
	\caption[Simulation experiment of the overall hybrid system with $\gamma = 2$]{Simulation experiment of the overall hybrid system carried out by settling $\gamma = 2$. The system parameters where $k = 5$, $b = 0.5$, $\lambda = 2$, $\mu = 1$, $k_d = 4.5$ and $\xb_0 = (-0.8,0)$. 
	Two switching signals have been given to the system in order to trigger the change of fixed point. The first one at time $t = 5s$ and the second one at time $t = 11.43s$. Black solid lines are parts of the system's trajectory with the nonlinear controller and the blue solid lines denote that the system was flowing uncontrolled. The dashed green lines are the the fixed points.
	}
	\label{fig:exp2}
\end{figure}
%
In the first case ($\gamma = 10^{-3}$), the transient from $\xb_1^*$ to $\xb_2^*$ (and vice versa) is very fast and without any oscillation in the displacement, due to the high dissipation rate and the minimised error norm: when the EB--PBC controller is switched--on again the state is very close to the desired energy minimum. However, the price of this performance is the impulse, i.e. state jump, that has to be generated. On the other hand, when $\gamma = 2$, no state discontinuity is needed to change working mode, but at the cost of a slower transient.
%
\clearpage
%
\section{Summary}
In this chapter, a novel technique for controlling stable linear time invariant systems which operate in a finite number of working modes has been presented. 
%
\newline

%
The theory of passivity--based control and port-Hamiltonian systems has been used to stabilize multiple fixed points of the closed-loop system. The proposed method allows then to switch among the desired working modes by engaging a hybrid mode selector triggered asynchronously by an external logic signal. Simulations have been performed to prove the validity of the control scheme. 
%
\newline

%
The final closed--loop system is hybrid in nature due to the applied control technique. Furthermore, it belongs to the class of hybrid port--Hamiltonian systems described in Chapter \ref{chap:HPH_systems}, with a model similar to the \textit{hopping robot} (see Fig. \ref{fig:hopping}).

