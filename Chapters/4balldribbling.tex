\definecolor{brickred}{rgb}{0.8, 0.25, 0.33}
%
\chapter{Iterative Energy Shaping of a Ball--Dribbling Robot}

\label{chap:balldribbling}
\minitoc

\thispagestyle{empty}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%
\lettrine[lines=4]{\color{brickred}C}{hallenging} control problems are often the best and most direct way to prove the validity of a modeling framework. In this chapter we present a novel method for controlling a \textit{ball--dribbling} robot.
A representation of the controlled system is given in Figure \ref{fig:bdcatchy}.
%
\begin{figure}[!ht]
    %
	\centering
	\input{Drawings/catchybb.tex}
	\caption{One--dimensional ball--dribbling robotic system. The position of the robot (rectangle), is represented by the variable $q_1$ while $u$ is an input force applied to it. Moreover, the position of the ball (circle), of radius $r$, is represented by $q_2$. }
	\label{fig:bdcatchy}
	%
\end{figure}
%

This model belongs to the class of \textit{impulsive port--Hamiltonian} systems. The ball--dribbling problem has been considered by \cite{Batz2010}. In their work authors assumed the absence of any viscous friction effect, the exact knowledge of the ball's mass and the experimental estimation of the impacts' restitution coefficients. Moreover, they assumed the end--effector of the robot to be elastic and thus no instantaneous robot--ball contacts were possible. A similar consideration can be done for \citep{haddadin2018exploiting}, where the elastic potential energy stored in the robot end--effector was exploited to perform the dribbling task. While compared to the previous work, our method, relax all the assumption by considering the viscous friction and do not require the knowledge of any parameter characterizing the ball's dynamics.

The novel control technique proposed in this paper attempts at casting energy shaping in a learning context. By ``learning'' here it is intended that the control law is adjusted on the bases of previous iterations. In chain, the concept of iterations, or trials, arise naturally in this context since for, the class of systems that are considered, the discontinuous dynamics separating the flows can be used to implicitly recognize trials without introducing additional structure.

Numerical simulations, performed to steer the output of such a system along a periodic reference, successfully demonstrate the efficacy of the proposed approach. In particular, in the simulation experiments, the control task that is achieved is the periodic bouncing of the ball by means of impacts at a constant and prescribed height.
%
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Model of the ball--dribbling robot}\label{sec:DBR}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Port-Hamiltonian Model of the Flows}
Let $q_1$ be the position of the robot, $q_2$ the position of the ball and $p_1 \triangleq  m_1\dot{q}_1$, $p_2 \triangleq  m_2\dot{q}_2$ the momenta of the robot and the ball respectively.
The state--space model of the system is:
%
\begin{equation}\label{eq:state-space}
    %
    \left\{ 
        \begin{matrix*}[l]\vspace{1pt}
            \dot{q}_1 = \dfrac{1}{m_1}p_1,~~&\dot{p}_1 = -m_1\gamma -\dfrac{\beta_1}{m_1}p_1 + u\\\vspace{1pt} 
            \dot{q}_2 = \dfrac{1}{m_2}p_2,~~&\dot{p}_2 = -m_2\gamma -\dfrac{\beta_2}{m_2}p_2

        \end{matrix*}
    \right.
    %
\end{equation}
%
being $\gamma$ the gravitational acceleration (i.e., $\gamma = 9.81{m}/{s^2}$), and $\beta_1$, $\beta_2>0$ the viscous friction coefficients. Let $\qb \triangleq (q_1,q_2)$, $\pb\triangleq (p_1,p_2)$ and $\xb \triangleq (\qb,\pb)$.
The system can be expressed in the canonical port--Hamiltonian form defining the Hamiltonian function as the total energy, i.e.
%
\begin{equation}
    \Ha(\qb,\pb) \triangleq \frac{1}{2}\pb^\top \Mb^{-1}\pb + \V(\qb)
\end{equation}
%
where $\Mb = \diag(m_1,m_2)$ and $\V(\qb) = \gamma[m_1,m_2]\qb$. Then, the port--Hamiltonian dynamics are defined by the system matrices
%
\begin{equation}
    %
    \Jb\triangleq
    \begin{bmatrix}
        %
        0&0&1&0\\
        0&0&0&1\\
        -1&0&0&0\\
        0&-1&0&0
        %
    \end{bmatrix},~~
    %
    \Rb\triangleq
    \begin{bmatrix}
        %
        0&0&0&0\\
        0&0&0&0\\
        0&0&\beta_1&0\\
        0&0&0&\beta_2
        %
    \end{bmatrix},~~
    %
    \Gb\triangleq
    \begin{bmatrix}
        %
        0\\0\\1\\0
        %
    \end{bmatrix}.
    %
\end{equation}
%
In this way, the natural pairing between input and output leads to
%
\begin{equation}
    y = \Gb^\top\dH= \frac{1}{m_1}p_1=\dot{q}_1
\end{equation}
%
Indeed, the flow set $\C$ is 
%
\begin{align}\label{eq:flowset}
    \C \triangleq &\left\{\xb:~q_1\geq q_2\geq 0\right\}\setminus\left[\left\{\xb:~q_2 = 0\land p_2<0\right\}\right.\cup\\
    &\left.\cup\{\xb:~q_1 = q_2\land (p_1p_2<0\lor m_2p_1< m_1p_2)\}\right]
\end{align}
%
\begin{rmk}
    The system is under--actuated as an input force can be applied on to the robot. Furthermore, the behavior of the robot does not influence in any way the flow of the ball, as can also be derived by physical considerations. However, the dynamics of the overall hybrid system will be coupled during jumps: the robot can influence the ball's motion (and vice versa) trough impacts.
\end{rmk}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Model of the Impacts}
%
Considering the ball-dribbling robot, discontinuities of the system's state may happen in two situations: during the collision between ball and the floor or the one between the robot and the ball. Here collisions are considered partially inelastic while both the robot and the ball, are modeled as rigid bodies.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Ball-Floor Collisions}$\newline$
%
The collision of the ball with the ground will causes a sudden change of the ball's momentum:
%
\begin{equation}
    p_2^+ = -c_gp_2
\end{equation}
%
where $c_g\in(0,1)$ is the \textit{ball-ground restitution coefficient}. Therefore, the resulting jump map is 
%
\begin{equation}
    %
    \xb^+ = {\gb}_1(\xb) = 
    \underbrace{\begin{bmatrix}
	    1 & 0 & 0 & 0\\
    	0 & 1 & 0 & 0\\
	    0 & 0 & 1 & 0\\
	    0 & 0 & 0 & -c_g 
	\end{bmatrix}}_{\Mb_1}
    \xb
    %
\end{equation}
%
The jump happens if $\xb\in\D_1$, where the jump set $\D_1$ is the following sub-manifold of the state space:
%
\begin{equation}
    \D_1 \triangleq \left\{\xb:~q_2 = 0\land p_2<0\right\}.
    \end{equation}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Robot-Ball Collisions}$\newline$
During the collisions between the robot and the ball, both the robot and ball momenta will change discontinuously as follows. 
The conservation law of the total momentum yields:
%
\begin{equation}
p_1^+ + p_2^+ = p_1 + p_2 
\end{equation}
%
Considering the partial inelasticity of the impacts:
%
\begin{equation}
\frac{p_1^+}{m_1} - \frac{p_2^+}{m_2} = -c_i\left(\frac{p_1}{m_1} - \frac{p_2}{m_2}\right) 
\end{equation}
%
where $c_i\in(0,1)$ is the \textit{robot-ball restitution coefficient}. It follows that
%
\begin{equation}
\begin{bmatrix}
p_1^+\\p_2^+
\end{bmatrix} = 
\begin{bmatrix}
p_1 -\mu(m_2p_1 - m_1p_2)\\
p_2 +\mu(m_2p_1 - m_1p_2)
\end{bmatrix},\quad \mu = \frac{c_i + 1}{m_1 + m_2}
\end{equation}
%
Thus, the corresponding jump map is
%
\begin{equation}
\xb^+ = {\gb}_2(\xb) = 
\underbrace{
\begin{bmatrix}
	1 & 0 & 0 & 0\\
	0 & 1 & 0 & 0\\
	0 & 0 & 1 - \mu m_2 & \mu m_1\\
	0 & 0 & \mu m_2 & 1 - \mu m_1\\ 
	\end{bmatrix}}_{\Mb_1}\xb
\end{equation}
%
The robot-ball collision happens if $\xb\in\D_2$, where the jump set $\D_2$ is:
%
\begin{align}
    \D_2 \triangleq \{\xb:~q_1 = q_2\land (p_1p_2<0\lor m_2p_1< m_1p_2)\}.
\end{align}
%
The overall jump set $\D$ is defined as
%
$\D \triangleq \D_1\cup\D_2$
%
and the resultant set--valued  mapping of the jumps is
%
\begin{equation}
    \G\triangleq \left\{{\gb}_i:\xb\in\D_i\Rightarrow \xb^+ = \gb_i(\xb),~ i = 1,2\right\}.
\end{equation}
%
The final hybrid system can be then written in the form (\ref{eq:impulsive_ph}).
%It is easy to verify, that the Hamiltonian function decreases during jumps, i.e. 
%\[
%$\Ha(g(\xb))\leq \Ha(\xb)\quad\forall \gb\in\mathcal{G},~\xb\in\D$. 
%\]
%
Note that the state-space manifold $\X$ is:
\begin{equation}
    \X \triangleq \C\cup\D = \left\{\xb:~q_1\geq q_2\geq 0\right\}.
\end{equation}
%
and that
%
\begin{align}
    \forall \xb\in\X\setminus\{\mymathbb{0}_4\}~~~\Ha(\xb)>0~~\land~~\Ha(\mymathbb{0}_4)=0
\end{align}
In Fig. \ref{fig:uHPH} the \textit{hybrid automata} of the autonomous system ($u = 0$), is represented.
%
\begin{figure}[!ht]
	\centering
	\input{Drawings/Autonomous_automata.tex}
	\caption{Hybrid automata of the autonomous system. It has a single mode for flows, described by an autonomous port-Hamiltonian system, and it has two jumps: $\gb_1$ resets the states during  \textit{ball--ground} collisions ($\xb\in\D_1$) while $\gb_2$ resets the states during  \textit{robot-ball} collisions ($\xb\in\D_2$).}
	\label{fig:uHPH}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\section{Analysis of the Autonomous Model}\label{sec:analysis_aut}
\subsection{Passivity and Autonomous Stability}
%
\begin{prop}
    The ball--dribbling robot is passive.
\end{prop}
%
\begin{proof}
    %
    Let $\hat{q}_1,~\hat{q}_2,~\hat{p}_1,~\hat{p}_2$ be the versors of the axes ${q}_1,~{q}_2,~{p}_1,~{p}_2$.
    %
    $\Ha(\xb)$ is nondecreasing along the eigendirections of $\gb_1$, $\gb_2$ which are, respectively, the one of the axis $(\hat{q}_1,\hat{q}_2,\hat{p}_1,\hat{p}_2)$ and $(\hat{q}_1, \hat{q}_2,m_2\hat{p}_1 + m_1\hat{p}_2,\hat{p}_1-\hat{p}_2)$, i.e. $\Ha$ is evenly diverging with respect to $\gb_1,~\gb_2$.
    %
    Thus, the ball--dribbling robot is passive for Proposition \ref{prop:pass_impulsive} as
    %
    $\Mb_1$ has eigenvalues $\lambda_{1,2,3} = 1$, $\lambda_4 = -c_g$ and $\Mb_2$ has eigenvalues $\lambda_{1,2,3} = 1$, $\lambda_4 = -c_i$, whose norms are indeed all less or equal than one.
    %
\end{proof}
%
Moreover, it very straightforward to prove that in the case of the autonomous system (u = 0), any neighborhood of the origin $\mymathbb{0}_4$ is a Lyapunov stable set.
%
\subsection{Chaotic Trajectories}
Let us consider the uncontrolled system and let set the physical parameters so that the system is conservative, i.e. $c_i = c_g = 1$, $\beta_1=\beta_2=0$. In this case, the Hamiltonian is constant in time,
%
\begin{equation}
    \forall t\geq 0 \quad \dot{\Ha}(\xb(t)) = 0
\end{equation}
%
In this case, trajectories happen on isolines of the Hamiltonian functions depending on the initial condition $\xb_0$:
%
\begin{equation}
    \forall t\geq 0 \quad \xb(t)\in\left\{\xb:\Ha(\xb) = \Ha(\x_0)\right\}
\end{equation}
%
and the volume of the phase--space is also conserved thanks to the Liuville theorem.
%

However, although the system is linear, it exhibits a chaotic behaviour due to its hybrid nature, with an exceptional sensitivity to the initial condition: trajectories starting ``very close'' tend to diverge in time (inside the limited phase--space).
%

This behaviour is shown by a numerical analysis performed through a Monte Carlo simulation integrating the system from 3000 initial conditions $\xb_0^i$ sampled by a multivariate normal distribution centered in a nominal initial condition $\xb_0$ and variance $\sigma = 10^{-6}$:
%
\begin{equation}
    \xb_0^i \sim \N(\xb_0,\sigma\mathbb{I}_n)
\end{equation}
%
Choosing $x_0\triangleq(2,1.5,0,0)$, $m_1 = 1\text{Kg}$, $m_2 = 0.15\text{Kg}$, the nominal trajectory (starting from $\xb_0$) and all the other 3000 ones have been integrated for $t = 20s$. The experiments have been carried out using Hybrid Equations (HyEQ) Toolbox \cite{sanfelice2013toolbox} for the MATLAB environment. The time evolution of the system's state in all the trials is shown in Fig. \ref{fig:chaos1}. The black trajectory is the nominal one (starting from $\xb_0$), where red dots and dashed blue lines indicate discrete events (impacts) and the value of the state after the events, respectively. Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial conditions. It can be noticed how trajectories, starting very close, diverge, densely covering the state--space.
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/chaos1.pdf}
    \caption[Time evolution of the autonomous system' state in the Monte Carlo simulation]{Time evolution of the autonomous system' state in the Monte Carlo simulation. The black trajectory is the nominal one (starting from $\xb_0$), where red dots and dashed blue lines indicate discrete events (impacts) and the value of the state after the events, respectively. Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial conditions. It can be noticed how trajectories, starting very close, diverge, densely covering the state--space.}
    \label{fig:chaos1}
\end{figure}
%

This phenomenon is further emphasized by looking at the phase--space trajectories of the robot and the ball, respectively, represented in Fig. \ref{fig:chaos2}. The dashed black line is the nominal one (starting from $\xb_0$). Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). 
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/chaos2.pdf}
    \caption[Phase--space trajectory of the autonomous system in the Monte Carlo simulation]{Phase--space trajectory of the autonomous system in the Monte Carlo simulation. The dashed black line is the nominal one (starting from $\xb_0$). Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at are the initial conditions. It can be noticed how trajectories, starting very close, diverge, densely covering the state--space.}
    \label{fig:chaos2}
\end{figure}
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/chaos3.pdf}
    \caption[Time evolution of the energy in the Monte Carlo simulation]{Time evolution of the energy in the Monte Carlo simulation. The black trajectory is the nominal one (starting from $\xb_0$), where red dots indicate discrete events (impacts). Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial energies of each Monte Carlo run. It can be noticed how, regardless the initial condition, energy is conserved in time.}
    \label{fig:chaos3}
\end{figure}

The time evolution of the energy (Hamiltonian function) among the Monte Carlo runs is also shown in Fig. \ref{fig:chaos3}. As expected, the energy is conserved trough time.
%

%
The experiment which has been done here numerically can be formalized as follows.
Instead of an initial condition, we considered an initial distribution (probability density) of the state $\psi(\xb_0)$ and we observed how this distribution evolved in time through the dynamics of the system, i.e. we approximated a solution of a partial differential equation of type
%
\begin{equation}
    \partial_t\psi(\xb) = \Gamma(\psi(\xb)).
\end{equation}
%
From the numerical Monte Carlo simulation, we build the histogram of the state at each value of the time are we built a phasegram plot representing the time evolution of state probability\footnote{i.e., the probability of finding the state of the system somewhere in the state--space.}, for each state of the system. It is reported in Figure \ref{fig:phasegram}. 
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = 1\linewidth, trim={5cm 5.75cm 3.9cm 5.5cm},clip]{Figures/PhaseGram.pdf}
    \caption[Phasegram of the state probability function]{Phasegram of the state probability computed from the Monte Carlo Simulation. At $t=0$ the state probability is just a spike across the initial condition. Throughout time, the probability relaxes to with much larger variance.}
    \label{fig:phasegram}
\end{figure}
%
At $t=0$ the state probability is just a spike across the initial condition, i.e. $\N(\xb_0,\sigma\mathbb{I}_n)$. Throughout time, however the probability relaxes to with much larger variance. It means that, although all trajectories started very close one to the other, after a short period of time, the state might be everywhere in the state--space. Thus, the properties of the autonomous conservative ball--dribbling robot system resembles the ones of some stochastic system where the system has no ``memory'' of its past.
The same result is emphasized by looking the computed initial and final probability density functions $\psi_i$ and $\psi_f$ in Fig. \ref{fig:hist}.
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = 1\linewidth]{Figures/Hist.pdf}
    \caption{Histograms and reconstructed probability density functions of the state.}
    \label{fig:hist}
\end{figure}
%
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Dribbling Control}\label{sec:control}
%
Let us consider the control task of continuously hitting the ball such that it reaches, at every cycle, the same maximum height $q_{2,max}^*$. In order to address this control problem, it is possible to design an hybrid controller with two modes, i.e., a \textit{wait mode} ($\Sa_{w}$) and a \textit{hit mode} ($\Sa_{h}$). In the wait state, the robot must stay at a constant height above the ball, to overcome any interference between its motion and the one of the ball and, at the same time, stay close enough to the ball to hit it quickly at the right time.
Then, in the hit state, the controller must move the robot toward the ball so that the exchanged impulse during the impact would lead the ball to come back to the desired peak $q_{2,max}^*$. In particular, the system would enter in the hit state whenever the ball reaches the peak of its bounce and switch back to the wait mode immediately after the impact between the two bodies. 
%
In both modes, we would like to exploit the passivity--based control theory. Besides, the system is under--actuated and the flows are decoupled. Therefore, it is impossible to shape the total energy of system setting its minimum in a desired configuration different from the origin. Although it is not possible to modify the energy of the ball, it is however possible to partially shape the Hamiltonian, i.e. the part relative to the robot. If 
%
\begin{equation}
    \Ha(\xb) = \Ha_1(q_1,p_1) + \Ha_2(q_2,p_2),
\end{equation}
%
it is possible to obtained a desired-shape Hamiltonian
%
\begin{equation}
     \Ha^*(\xb)  = \Ha_1^*(q_1,p_1) + \Ha_2(q_2,p_2)
\end{equation}
%
allowing to bring the robot in a desired configuration $q_1^*$. This might be achieved through an \textit{energy--balancing passivity--based controller}\footnote{In this case $q_1^*$ becomes a strict minimum of $\Ha_1^*$ and asymptotic stabilization must be achieved with $p_1 = 0$ at steady--state} \citep{ortega2001putting,ortega2008control,secchi2007control} described in Chapter \ref{chap:preliminaries}:
%
\begin{align*}
u &= \beta(\xb) + v = \beta(\xb) - k_dy \\
&= \frac{\partial V_1(q_1)}{\partial q_1} - k_p(q_1 -q_1^*) - k_d\dot{q}_1\\
&= \gamma m_1q_1- k_p(q_1 -q_1^*) - k_d\dot{q}_1
\end{align*}
%
As pointed out before, the controller has two separate modes and the control parameters $k_p$, $k_d$, $q_1^*$ should be changed during the state transitions.
% 
For this reason, let us collect the control parameters in a vector 
%
\begin{equation}
    \bm\omega = (k_p,k_d,q_1^*)
\end{equation}
%
and consider it as part of the state vector. The augmented model of the controlled system can be then rewritten as follows:
\begin{equation}\label{eq:HpHc}
    %
    \left\{ 
        \begin{matrix*}[l]\vspace{1pt}
            %
            \begin{bmatrix}\dot{\xb}\\\dot{\bm\omega}\end{bmatrix} = \begin{bmatrix}\left[\Jb-\Rb\right]{\dH^*(\xb)}+\Gb v(\x,\bm\omega)\\\mymathbb{0}_3\end{bmatrix} &(\xb,\bm\omega,v)\in\C\times\Omega\times\U\\
            %
            \begin{bmatrix}{\xb}^+\\{\bm\omega}^+\end{bmatrix} \in \G\times\Lambda&(\xb,\bm\omega)\in\D\times\Omega\\
            %
            y = \Gb^\top{\dH^*(\xb)}
        \end{matrix*}
    \right.
    %
\end{equation}
%
where $\Omega$ is the space of admissible parameters values and $\Lambda$ is the jump set--valued mapping of the control parameters. The shaped Hamiltonian $\Ha^*(\xb,\bm\omega)$, results to be
\[\Ha^*(\xb,\bm\omega) = \frac{1}{2}\pb^\top \Mb^{-1}\pb + \frac{1}{2}k_p(q_1 - q_1^*)^2+ \gamma m_2q_2\]
Notice that the choice of the control parameters influences both the closed-loop energy $\Ha^*$ (with $k_p$ and $q_1^*$) and the output feedback $v$ (with $k_d$).
%
Let us define a jump set $\D_3$ corresponding to the sub--manifold of the state--space where the ball reaches the peak $q_{2,max}$ of its bounce: $\D_3 = \left\{\xb:~p_2=0\right\}$.
It is clear that during the time evolution of the system, the state will cyclically enter in $\D_3$ and therefore the controller will periodically switch to $\Sa_h$ where the robot moves toward the ball until they collide, i.e. $\xb\in\D_2$, when the controller switches back to $\Sa_w$ where the robot waits above the ball at a distance $\delta$. The jumps maps resetting the control parameters are the following:
%
\begin{align*}
\bm\omega^+ = \bm\nu_{3}(\xb,\bm\omega) &=\begin{bmatrix}k_{p,h}&k_{d,h}&q_2\end{bmatrix}^\top &\quad&\xb\in\D_3\\
\bm\omega^+ = \bm\nu_{2}(\xb,\bm\omega) &=\begin{bmatrix}k_{p,w}&k_{d,w}&q_2 + \delta\end{bmatrix}^\top &\quad&\xb\in\D_2\\
\bm\omega^+ = \bm\nu_{1}(\xb,\bm\omega) &= \bm\omega &\quad&\xb\in\D_1
\end{align*}
%
Therefore,
%
\begin{equation}
    \Lambda \triangleq \left\{{\bm\nu}_i:\xb\in\D_i\Rightarrow \bm\omega^+ = \bm\nu_i(\bm\omega,\xb),~ i = 1,2,3\right\}.
\end{equation}
%
Figure \ref{fig:ctrl} shows the finite--state machine representing the controller.
When $\xb\in\D_3$, the state of the system does not jump, i.e. $\xb^+ = \gb_3(\xb)= \xb$ if $\xb\in\D_3$.
The set-valued mapping $\G$ is redefined considering $\gb_3$.
%
\begin{figure}[!ht]
	\centering
	\begin{tikzpicture}
	%
	\fill[gray!20, draw = black,thick] (-1.3,0) circle (0.8cm);
	\fill[gray!20, draw = black,thick] (1.3,0) circle (0.8cm);
	%	
	\draw (-1.3,0) node[align = center](flow)  {$S_{w}$\\$u(\xb,\bm\omega)$};
	\draw (1.3,0) node[align = center](flow)  {$S_{h}$\\$u(\xb,\bm\omega)$};
	%
	\draw [thick,->] plot [smooth, tension=1.2] coordinates { (-1,0.74162) (0,1) (1,0.74162)};
	\draw [thick,->] plot [smooth, tension=1.2] coordinates { (1,-0.74162) (0,-1) (-1,-0.74162)};
	%
	\draw (1.9,1) node {$\bm\omega^+ = \bm\nu_{3}(\xb,\bm\omega)$};
	\draw (1.4,-1) node {$\xb\in\D_2$};
	%
	%
	\draw (-1.9,-1.1) node {$\bm\omega^+ = \bm\nu_{2}(\xb,\bm\omega)$};
	\draw (-1.4,1) node {$\xb\in\D_3$};
	%
	\end{tikzpicture}
	\caption{Finite state machine of the controller. It has an \textit{hit} state $\Sa_h$ in which it forces the robot to move toward the ball and a \textit{wait} state $\Sa_w$ in which it keeps the robot at a constant distance $\delta$ from the ball.The transitions happen as follows: $\Sa_h\rightarrow\Sa_w$ when the robot hits the ball, $\Sa_w\rightarrow\Sa_h$ when the ball reaches the peak of its bounce.}
	\label{fig:ctrl}
\end{figure}
%
\begin{rem}
    The behavior of the system strongly depends on the choice of the control parameters. Furthermore, unless a solution of (\ref{eq:HpHc}) is derived, it is not possible to find analytically two sets of control parameters (one for $S_{w}$ and one for $S_{h}$) which solve the control problem, i.e. ensuring that the ball bounces continuously reaching each time the desired peak $q_{2,max}^*$.
\end{rem}
 For the reasons stated in previous remark, a new paradigm of energy based control, which combines the traditional energy shaping approach with a basic form of {iterative learning control}: the \textit{iterative energy shaping}, has been introduced.
\begin{defn}[Iterative Energy Shaping Control]$\newline$
	First, let us define some further control parameters which are needed for the design.
	Let $\xi$ be a counter of the number of cycles of the system, i.e., the number of complete bounces of the ball. Let initialize $\xi$ to one. Let $e(\xi) = q_{2,max}^* - q_{2,max}$ computed when $\xb\in\D_3$ be the tracking error of the iterative energy shaping control loop. Thus, the control parameters vector can be redefined as 
	%
	\begin{equation}
	    \bm\omega \triangleq (k_p,k_d,q_1^*,\xi).
	\end{equation}
	%
	The iterative energy shaping control law is defined by means of the following control parameters jump maps:
	%
	\begin{align}
	&\bm\omega^+  \triangleq \bm\nu_{3}(\xb,\bm\omega)=\begin{bmatrix}k_0\varphi_\xi(e)&k_{d,h}&q_2&\xi+1\end{bmatrix}^\top &\xb\in\D_3\\
	&\bm\omega^+  \triangleq \bm\nu_{2}(\xb,\bm\omega)=\begin{bmatrix}k_{p,w}&k_{d,w}&q_2 + \delta&\xi\end{bmatrix}^\top &\xb\in\D_2
	\end{align}
	%
	where $\sigma>0$ is a constant scalar and $\varphi_\xi(e)$ is a scalar function of the error. When the controller is in the \textit{hit} state, the resulting shaped Hamiltonian assumes the following form:
	\begin{equation}
		\Ha^*(\xb,\bm\omega) = \frac{1}{2}\pb^\top \Mb^{-1}\pb + \frac{1}{2}k_0\varphi_\xi(e)(q_1 - q_1^*)^2+ \gamma m_2q_2
	\end{equation}
\end{defn}
%
A representation of the \textit{hybrid automata} corresponding to the final controlled system is pictured in Fig. \ref{fig:cHPH}.
%
\begin{figure}[!ht]
	%
	\centering
	%
	\scalebox{1}{
		\begin{tikzpicture}
		% 
		\fill[gray!20, draw = black,thick] (0,0) ellipse (2.5cm and 1.5cm);
		%	
		\draw (0,0) node[align = center](flow)  {$\xb\in\C$\\\\$\begin{bmatrix}\dot{\xb}\\\dot{\bm\omega}\end{bmatrix} = \begin{bmatrix}\left[\Jb-\Rb\right]\dH^*(\xb)+\Gb v\\\mymathbb{0}_4\end{bmatrix}$\\$y = \Gb^\top\dH^*(\xb)$};
		%
		\draw [thick,->] plot [smooth, tension=2] coordinates { (-0.5,1.4697) (0,2.2) (0.5,1.4697)};
		\draw [thick,->] plot [smooth, tension=2] coordinates { (2.5,0) (2.9,-.7) (2.1,-0.8139)};
		\draw [thick,->] plot [smooth, tension=2] coordinates { (-2.5,0) (-2.9,-.7) (-2.1,-0.8139)};
		%
		\draw (3.1,0.2) node {$\xb\in\D_2$};
		\draw (2.9,-1.75) node[align = left] {$\begin{bmatrix}\xb^+\\\bm\omega^+\end{bmatrix} = \begin{bmatrix}\gb_2(\xb)\\\bm\nu_2(\xb,\bm\omega)\end{bmatrix}$};
		%
		\draw (-3.1,0.2) node {$\xb\in\D_1$};
		\draw (-2.7,-1.75) node[align = left] {$\begin{bmatrix}\xb^+\\\bm\omega^+\end{bmatrix} = \begin{bmatrix}\gb_1(\xb)\\\bm\nu_1(\xb,\bm\omega)\end{bmatrix}$};;
		%
		\draw (-1.1,1.7) node {$\xb\in\D_3$};
		\draw (2.2,1.9) node[align = left] {$\begin{bmatrix}\xb^+\\\bm\omega^+\end{bmatrix} = \begin{bmatrix}\gb_3(\xb)\\
		\bm\nu_3(\xb,\bm\omega)\end{bmatrix}$};
		%
		\end{tikzpicture}
	}
	\caption[!hybrid automata representing the controlled system]{Hybrid automata representing the controlled system. Although the \textit{iterative energy shaping} controller has two modes, the controlled system is still an impulsive port--Hamiltonian system}
	\label{fig:cHPH}
\end{figure}
%
The main idea is to iteratively adjust the slope (steepness) of the energy of the system as function of the error. For instance, when $e>0$, it can be derived that the robot had hit the ball with not enough momentum. Thus, at the next cycle, the energy function should be steeper so that the robot will accelerate faster toward the ball, since the dissipation rate $k_d$ of the damping injection didn't change. The same concept can be adopted for $e<0$, by making the the energy function less steep.
%
A possible choice of $\varphi_\xi(e)$ is
%
\begin{equation}
    \varphi_\xi(e)  \triangleq \varphi_0 + a\cdot e(\xi) + b\cdot\sum_{i = 1}^{\xi}e(i)
\end{equation}
%
which provides a proportional and integral action with a constant offset $\varphi_0$ in response to the error. The integral action should ensure zero steady state error.
%
\section{Numerical Simulations}
%
To validate the proposed control scheme, numerical simulations have been performed. The physical parameters of the system have been chosen as $m_1 = 0.1\text{Kg}$, $m_2 = 0.05\text{Kg}$, $\beta_1 = 0.2\text{N}\cdot \text{s}/\text{m}$, $\beta_2 = 0.3\text{N}\cdot \text{s}/\text{m}$, $c_g = c_i = 0.8$. The initial conditions have been set to $q_1(0) = 2$m, $q_2(0) = 1.5$m, $p_1(0) = p_2(0) = 0\text{Kg}\cdot \text{m}/\text{s}$. Note that the mass of the ball $m_2$ has been chosen similar to the one of a standard golf ball ($\approx 46g$).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Autonomous System}
%
Firstly, the behavior of the uncontrolled system has been simulated. The time evolution of the state variables are shown in Fig. \ref{fig:aut1}.
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width = \linewidth]{Figures/aut1.pdf}
	\caption[Uncontrolled system: time evolution of the robot and ball position states]{Uncontrolled system: time evolution of the robot and ball position states (position and momentum). Red dots correspond to system's jumps while dashed blue lines highlight discontinuous state changes. Notice that both the position and velocity goes asymptotically to zero.}
	\label{fig:aut1}
\end{figure}
%
The phase--space trajectory of the autonomous system is also represented in Fig. \ref{fig:aut2} over the energy of the system. 
%
\begin{figure}[!ht]
	\centering
    %\input{Drawings/aut2.tex}
	\caption[Uncontrolled system: Phase--space trajectory over the energy function]{Uncontrolled system: Phase--space trajectory over the energy function. Red dots correspond to system's jumps while dashed blue lines highlight discontinuous state changes. Notice that both the position and velocity goes asymptotically to zero.}
	\label{fig:aut2}
\end{figure}
%
Finally, the time evolution of the Hamiltonian function is shown in Fig. \ref{fig:aut3} while Fig. \ref{fig:aut4} shows how the energy is distributed within the system during its time evolution.
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/aut3.pdf}
	\caption[Uncontrolled system: time evolution of the Hamiltonian function.]{Uncontrolled system: time evolution of the Hamiltonian function. Due to system's passivity, the energy monotonically decreases to zero both during flow and jumps.}
	\label{fig:aut3}
\end{figure}
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/aut4.pdf}
	\caption[Uncontrolled system: Energy distribution within the system.]{Uncontrolled system: Energy distribution within the system. Trajectories happen on decreasing level--sets of $\Ha$, even if $\Ha_1$ and $\Ha_2$ may locally increase after some ball--robot impacts.}
	\label{fig:aut4}
\end{figure}
%
%
It can be noticed that $\Ha$ presents a monotonically decreasing trend, in both flows (due to the viscous friction terms) and jumps (since the restitution coefficients are less than one). In fact, trajectories happen on decreasing level--sets of $\Ha$, even if $\Ha_1$ and $\Ha_2$ may locally increase after some ball--robot impacts. Moreover, from the figures it is easily to verify the asymptotic stability and attractivity of the origin ($x = \mymathbb{0}_4$) and the \textit{Zeno behavior} of the autonomous system (see \cite{goebel2009hybrid}).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Controlled System}
%
Simulations of the system controlled via iterative energy shaping have also been performed. The control parameters have been chosen as: $k_{p,w} = 10^4$, $k_{d,w} = 10^3$, $\delta = 0.05$m, $k_0 = 10$, $k_{d,h} = 0$, $\varphi_\xi(e) = 10e + 100\sum_{i = 1}^{\xi}e(i)$, $q_{2,max}^* = 0.1$m. The time evolution of the state variables are shown in Figs. \ref{fig:ctrl1} and \ref{fig:ctrl1_det}.
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl1.pdf}
	\caption[Iterative energy shaping control: time evolution of the robot and ball states]{Iterative energy shaping control: time evolution of the robot and ball states (position and momentum). Red dots correspond to system's jumps while dashed blue lines highlight discontinuous state changes. Notice that the ball states converge on a periodic trajectory reaching at each bounce the desired peak $q^*_{2,max}$ (dotted green line).}
	\label{fig:ctrl1}
\end{figure}
%
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl1_det.pdf}
	\caption[Iterative energy shaping control: detailed view of the time evolution of the ball and robot positions at steady state]{Iterative energy shaping control: detailed view of the time evolution of the ball and robot positions at steady state.}
	\label{fig:ctrl1_det}
\end{figure}
%
%
Notice that the trajectory of the ball becomes periodic (asymptotically), reaching at each bounce the desired peak $q_{2,max}^*$, proving the effectiveness of the proposed control scheme. Furthermore, the time evolution of the energy function is shown in Figs. \ref{fig:ctrl3} and \ref{fig:ctrl3_det} while Figs. \ref{fig:ctrl4} and \ref{fig:ctrl4_det} show how the energy flows across the system during each period. 
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl3.pdf}
	\caption{Iterative energy shaping control: the time evolution of the Hamiltonian function. After a short transient also the system's energy becomes periodic.}
	\label{fig:ctrl3}
\end{figure}
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl3_det.pdf}
	\caption{Iterative energy shaping control: detailed view of the time evolution of the Hamiltonian function at steady state to highlight its (asymptotic) periodicity.}
	\label{fig:ctrl3_det}
\end{figure}
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl4.pdf}
	\caption{Iterative energy shaping control: the time evolution of the Hamiltonian function. After a short transient also the system's energy becomes periodic.}
	\label{fig:ctrl4}
\end{figure}
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl4_det.pdf}
	\caption{Iterative energy shaping control: detailed view of the time evolution of the Hamiltonian function at steady state to highlight its (asymptotic) periodicity.}
	\label{fig:ctrl4_det}
\end{figure}
%
As expected also the energy becomes periodic. In fact, the energy at the beginning and at the end of each cycle (bounce) become exactly the same. Moreover, we can see that, at steady state, during the ball--robot impact, the robot transfers to the ball the exact amount of energy necessary to reach the desired bounce peak. Finally, as shown in Fig. \ref{fig:ctrl5} the error goes to zero with the number of cycles.
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl5.pdf}
	\caption{Iterative energy shaping control: (discrete) time evolution of the tracking error $e$ and of the energy shaping gain $\varphi_\xi(e)$. As the number of cycles $\xi$ increases, the tracking error $e$, i.e. the difference between the desired and ball's bounce peak, goes asymptotically to zero. Instead, the energy shaping gain converges, increasing monotonically, to a constant value.}
	\label{fig:ctrl5}
\end{figure}
%
On the other hand, the function $\varphi_\xi(e)$ converges exponentially to a positive constant value. 
%
A final consideration about the convergence of the system to the desired periodic trajectory can be made from the phase-space portrait of the system's trajectory (Fig. \ref{fig:ctrl2}). Being the time represented by the color transition, it can be noticed that the system approaches a limit cycle, an attractive asymptotically periodic trajectory, in which the tracking error is zero.
%
%
\begin{figure}[!ht]
	\centering
	%\includegraphics[width=\linewidth]{Figures/ctrl2.pdf}
	\caption[Iterative energy shaping control: phase--space trajectories]{Iterative energy shaping control: projections on the $q_1-p_1$ plane (above) and the $q_2-p_2$ plane (below) of the phase-space trajectory of the system. The system converges to a hybrid limit cycle in which $e=0$.}
	\label{fig:ctrl2}
\end{figure}
%
\clearpage
%
\subsection{Numerical Stability and Robustnes Analysis}
%
\subsubsection{Robustness to Initial Condition}
In order to prove the numerically the stability and robustness of the proposed control scheme, a Monte Carlo experiment similar to the one proposed in Section \ref{sec:analysis_aut}, has been performed. In particular, choosing as physical parameters $m_1=0.1\text{Kg}$, $m_2=0.15\text{Kg}$, $\beta_1=0.2$, $\beta_2=0.3$, $c_1=c_2=0.8$ and control parameters $k_{p,w} = 10^4$, $k_{d,w} = 10^3$, $\delta = 0.5$, $\sigma = 10$, $k_{d,h} = 10^2$, $\varphi_\xi(e) = 3000 + 10e + 300\sum_{i = 1}^{\xi}e(i)$, $q_{2,max}^* = 1$, 3000 trajectories has been computed starting from initial conditions $\xb_0^i$ sampled by the normal distribution
%
\begin{equation}
    \N(\xb_0,\sigma\mathbb{I}_n)
\end{equation}
%
with $\xb_0\triangleq(2,1.5,0,0)$ and $\sigma=1$. The time evolution of the system's state in all the trials is shown in Fig. \ref{fig:reg1}.
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/reg1.pdf}
    \caption[Time evolution of the controlled system' state in the Monte Carlo simulation]{Time evolution of the controlled system' state in the Monte Carlo simulation. The black trajectory is the nominal one (starting from $\xb_0$), where red dots and dashed blue lines indicate discrete events (impacts) and the value of the state after the events, respectively. Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial conditions. It can be noticed how trajectories, starting far from each other, eventually converge to the nominal trajectory.}
    \label{fig:reg1}
\end{figure}
%
The black trajectory is the nominal one (starting from $\xb_0$), where red dots and dashed blue lines indicate discrete events (impacts) and the value of the state after the events, respectively. Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial conditions. It can be noticed how trajectories, starting far from each other, eventually converge to the nominal trajectory. This means that the controller generates an attractive limit cycle. This can be seen indeed also in Fig. \ref{fig:reg2} where the phase--space trajectories are represented.
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/reg2.pdf}
    \caption[Phase--space trajectory of the controlled system in the Monte Carlo simulation]{Phase--space trajectory of the controlled system in the Monte Carlo simulation. The dashed black line is the nominal one (starting from $\xb_0$). Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at are the initial conditions. It can be noticed how trajectories, starting far from each other, eventually converge to the nominal trajectory.}
    \label{fig:reg2}
\end{figure}
%
\begin{figure}[!ht]
    \centering
    %\includegraphics[width = \linewidth]{Figures/reg3.pdf}
    \caption[Time evolution of the energy in the Monte Carlo simulation]{Time evolution of the energy in the Monte Carlo simulation. The black trajectory is the nominal one (starting from $\xb_0$), where red dots indicate discrete events (impacts). Orange lines show the traces of all the other trajectories of the Monte Carlo runs (with initial condition sampled from $\N(\xb_0,\sigma\mathbb{I}_n)$). The blue dots at $t=0$ are the initial energies of each Monte Carlo run.}
    \label{fig:reg3}
\end{figure}

The time evolution of the energy (Hamiltonian function) among the Monte Carlo runs is also shown in Fig. \ref{fig:reg3}.
%
\subsubsection{Robustness to Change of Reference}
%
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Summary}\label{sec:concl}
%
In this chapter, inspired by the theory developed in Chapter \ref{chap:HPH_systems}, a new paradigm of energy based control for the ball--dribbling robot, the \textit{iterative energy shaping}, has been introduced.
%
\newline

%
An accurate analysis of the autonomous model has been carried out, underlying its chaotic behaviour.
Numerical simulations have been then performed to prove the effectiveness of the proposed control scheme.
%
\newline

%
The aim of the next chapter is to give an idea of the ubiquity of the hybrid port--Hamiltonian framework is. First, a novel hybrid nonlinear controller is developed to solve a theoretical problem for linear system. Then, it is shown that the controlled system belongs to the class of hybrid port--Hamiltonian systems. 